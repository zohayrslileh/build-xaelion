"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ClientError_1=__importDefault(require("./ClientError")),Configs_1=require("#/Configs"),Listener_1=__importDefault(require("./Listener"));class Router{server;Namespace;routes=[];middlewares=[];deepRouter;constructor(e){this.deepRouter=e,this.route=this.route.bind(this),this.execute=this.execute.bind(this),this.middleware=this.middleware.bind(this),this.onconnection=this.onconnection.bind(this)}route(e,t){if(!this.server)throw new Error("Server not found");t.execute(this.server,[...this.routes,e],[...this.middlewares])}get namespace(){if(!this.Namespace){if(!this.server)throw new Error("Server not found");this.Namespace=this.server.of("/"+this.routes.join("/"))}return this.Namespace}middleware(...e){this.middlewares.push(...e)}onconnection(i){const s=[...this.middlewares];this.namespace.on("connection",async t=>{try{var e=new Listener_1.default(this.namespace,t);for(const r of s)await r(e);await i(e)}catch(e){e instanceof ClientError_1.default?t.emit("error",e.message):t.emit("error",Configs_1.DEV_MODE?String(e):"Internal error"),t.disconnect()}})}execute(e,t,r){this.server=e,t&&(this.routes=t),r&&(this.middlewares=r),this.deepRouter(Object.assign(this,{execute:void 0}))}}function router(e){return new Router(e)}exports.default=router;